name: Process Attendance

on:
  repository_dispatch:
    types: [attendance-scan]

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  record-attendance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Record Attendance
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { qrData, timestamp, displayTime, source } = context.payload.client_payload;
          
          console.log('Processing attendance record:', { qrData, displayTime, source });
          
          // Parse QR data to extract mobile, name, and service
          let mobileNumber = '';
          let fullName = '';
          let service = '';
          
          try {
            // The QR data appears to be in Arabic JSON-like format
            const qrText = qrData || '';
            
            // Extract mobile number
            const mobileMatch = qrText.match(/Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„["":]+"?([^"""}]+)/);
            if (mobileMatch) {
              mobileNumber = mobileMatch[1].replace(/[""]/g, '').trim();
            }
            
            // Extract full name
            const nameMatch = qrText.match(/Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ["":]+"?([^"""}]+)/);
            if (nameMatch) {
              fullName = nameMatch[1].replace(/[""]/g, '').trim();
            }
            
            // Extract service
            const serviceMatch = qrText.match(/Ø§Ù„Ø®Ø¯Ù…Ø©["":]+"?([^"""}]+)/);
            if (serviceMatch) {
              service = serviceMatch[1].replace(/[""]/g, '').trim();
            }
          } catch (parseError) {
            console.log('Error parsing QR data:', parseError);
            // Fallback to original data
            mobileNumber = qrData;
          }

          console.log('Parsed data:', { fullName, mobileNumber, service });
          
          try {
            // Add a small delay to avoid race conditions
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Try to get existing attendance.csv
            let content = '';
            let fileSha = undefined;
            
            try {
              const file = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'attendance.csv'
              });
              content = Buffer.from(file.data.content, 'base64').toString();
              fileSha = file.data.sha;
              console.log(`ðŸ“„ Found existing CSV file with SHA: ${fileSha}`);
            } catch (e) {
              // File doesn't exist, create header
              console.log('attendance.csv not found, creating new file');
              content = '"Timestamp","Mobile Number","Full Name","Service"\n';
            }
            
            // Validate required data before processing
            if (!mobileNumber || !fullName || !service) {
              console.log(`âŒ Invalid QR data - missing required fields:`);
              console.log(`Mobile: "${mobileNumber}", Name: "${fullName}", Service: "${service}"`);
              
              // Create issue for invalid data attempt
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `âŒ Invalid QR Data Attempt - ${displayTime} [skip ci]`,
                body: `
                ## âŒ Invalid QR Data Detected
                
                - **ðŸ“± Mobile**: "${mobileNumber}"
                - **ðŸ‘¤ Name**: "${fullName}"
                - **â›ª Service**: "${service}"
                - **ðŸ•’ Attempt Time**: ${displayTime}
                - **âŒ Status**: **REJECTED - Missing required data**
                
                **Raw QR Data**: \`${qrData}\`
                `,
                labels: ['attendance', 'invalid', 'rejected']
              });
              
              return; // Exit without updating CSV
            }
            
            // Check for duplicate attendance on the same day
            if (content && mobileNumber) {
              const lines = content.split('\n').filter(line => line.trim());
              console.log(`ðŸ” Checking for duplicates of mobile: "${mobileNumber}"`);
              console.log(`ðŸ“‹ CSV has ${lines.length} lines to check`);
              console.log(`ðŸ“„ Current CSV content:`, content.substring(0, 500));
              
              const duplicateFound = lines.some((line, index) => {
                // Skip header line - check for both quoted and unquoted headers
                if (line.includes('Timestamp') || line.includes('Mobile Number') || index === 0) {
                  console.log(`â­ï¸ Skipping header line ${index}: ${line.substring(0, 50)}`);
                  return false;
                }
                
                console.log(`ðŸ” Processing line ${index}: ${line}`);
                
                // Proper CSV parsing - the timestamp has a comma in it!
                // Format: "9/27/2025, 1:53:05 AM","01274539819","Name","Service"
                const parts = line.split(',');
                console.log(`ðŸ“ Split parts (${parts.length}):`, parts.map(p => `"${p}"`));
                
                if (parts.length < 5) {  // Should be 5 parts due to comma in timestamp
                  console.log(`â­ï¸ Skipping malformed line ${index}: only ${parts.length} parts`);
                  return false;
                }
                
                // Mobile number is in parts[2] because timestamp contains a comma
                const csvMobile = parts[2].replace(/"/g, '').trim();
                console.log(`ðŸ” Comparing mobiles: CSV="${csvMobile}" vs New="${mobileNumber}"`);
                
                if (csvMobile === mobileNumber) {
                  // Reconstruct timestamp from parts[0] and parts[1]
                  const csvTimestamp = (parts[0] + ',' + parts[1]).replace(/"/g, '').trim();
                  console.log(`ðŸ“… Found matching mobile! Checking dates...`);
                  console.log(`ðŸ•’ Reconstructed timestamp: "${csvTimestamp}"`);
                  
                  try {
                    const entryDate = new Date(csvTimestamp);
                    const today = new Date();
                    const entryDay = entryDate.toDateString();
                    const todayDay = today.toDateString();
                    
                    console.log(`ðŸ“… Date comparison: Entry="${entryDay}" vs Today="${todayDay}"`);
                    
                    if (entryDay === todayDay) {
                      console.log(`ðŸš¨ DUPLICATE DETECTED! Mobile ${csvMobile} already recorded today at ${csvTimestamp}`);
                      return true;
                    } else {
                      console.log(`âœ… Different day - allowing entry`);
                    }
                  } catch (dateError) {
                    console.log(`âš ï¸ Date parsing error: ${dateError.message}`);
                  }
                }
                
                return false;
              });
              
              if (duplicateFound) {
                console.log(`âš ï¸ Duplicate attendance detected for ${fullName} (${mobileNumber}) today`);
                console.log(`âŒ Attendance not recorded - already present for today`);
                
                // Create a GitHub issue to log the duplicate attempt
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `âš ï¸ Duplicate Attendance Attempt: ${fullName} - ${displayTime} [skip ci]`,
                  body: `
                  ## âš ï¸ Duplicate Attendance Detected
                  
                  - **ðŸ‘¤ Name**: ${fullName}
                  - **ðŸ“± Mobile**: ${mobileNumber}
                  - **â›ª Service**: ${service}
                  - **ðŸ•’ Attempt Time**: ${displayTime}
                  - **âŒ Status**: **REJECTED - Already recorded today**
                  
                  This person has already been recorded for attendance today.
                  `,
                  labels: ['attendance', 'duplicate', 'rejected']
                });
                
                return; // Exit without updating CSV
              }
            }
            
            console.log('âœ… No duplicate found, proceeding with attendance recording');
            
            // Create CSV line with proper UTF-8 encoding
            const csvLine = `"${displayTime}","${mobileNumber}","${fullName}","${service}"\n`;
            
            // Append new record
            const newContent = content + csvLine;
            
            // Update or create file with proper UTF-8 encoding
            const updateResult = await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'attendance.csv',
              message: `ðŸ“‹ Attendance: ${fullName || mobileNumber || 'Unknown'} - ${displayTime} [skip ci]`,
              content: Buffer.from(newContent, 'utf8').toString('base64'),
              sha: fileSha
            });
            
            console.log(`âœ… Attendance recorded successfully for ${fullName}`);
            console.log(`ðŸ“„ CSV file updated successfully`);
            
          } catch (csvError) {
            console.error('Error updating CSV:', csvError);
            throw csvError;
          }
